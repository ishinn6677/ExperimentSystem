<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
		<link rel="stylesheet" href="layui/css/layui.css" media="all">
		<link rel="stylesheet" href="css/experiment_list.css" />
	</head>
	<body>
<!--	表格内容-->
		<div class="layui-fluid">
			<div class="layui-card">
				<!-- 卡片头部——搜索框 -->
				<div class="layui-card-header layui-form">
					<div class="layui-form-item">
						<div class="layui-inline">
							<label class="layui-form-label">实验名称</label>
							<div class="layui-input-inline">
								<input type="text" name="exName" placeholder="请输入" autocomplete="off" class="layui-input" id="search_exName">
							</div>
						</div>
						<div class="layui-inline">
							<label class="layui-form-label">年份</label>
							<div class="layui-input-inline">
								<input type="text" name="year" placeholder="请输入" autocomplete="off" class="layui-input" id="search_year">
							</div>
						</div>
						<div class="layui-inline">
							<label class="layui-form-label">学期</label>
							<div class="layui-input-inline">
								<select name="term" id="search_term">
									<option value="0">不限</option>
									<option value="1">第1学期</option>
									<option value="2">第2学期</option>
								</select>
							</div>
						</div>
						<div class="layui-inline">
							<button class="layui-btn layui-btn-fluid ex_search"  data-type="reload">
								<i class="layui-icon layui-icon-search"></i>
							</button>
						</div>
					</div>

				</div>
				<!-- 卡片内容——数据表格 -->
				<div class="layui-card-body">
					<table id="experiment_list" lay-filter="experiment_list"></table>
				</div>
			</div>
		</div>
<!--		查看详情用的表单-->
		<form class="layui-form info-form" lay-filter="info-form" style="display: none" action="">
			<div class="idItem layui-form-item long-inpupt">
				<label class="layui-form-label">实验ID</label>
				<div class="layui-input-inline">
					<input class="layui-input" name="id" style="color: red;" type="text" readonly="readonly">
				</div>
			</div>

			<div class="layui-form-item long-inpupt">
				<label class="layui-form-label">实验名称</label>
				<div class="layui-input-inline">
					<input class="layui-input" type="text" name="exName"  readonly="readonly">
				</div>
			</div>
			<div class="layui-form-item long-inpupt">
				<label class="layui-form-label">可上机机房</label>
				<div class="layui-input-inline">
					<input class="layui-input" type="text" name="room"  readonly="readonly">
				</div>
			</div>

			<div class="layui-form-item mid-inpupt">
				<div class="layui-inline">
					<label class="layui-form-label">年份</label>
					<div class="layui-input-inline">
						<input name="year" type="text" class="layui-input" id="year"  readonly="readonly">
					</div>
				</div>
			</div>

			<div class="layui-form-item mid-inpupt">
				<div class="layui-inline">
					<label class="layui-form-label">学期</label>
					<div class="layui-input-inline">
						<input class="layui-input" type="text" name="term"  readonly="readonly">
					</div>
				</div>
			</div>

			<div class="layui-form-item long-inpupt">
				<label class="layui-form-label">报告截止日期</label>
				<div class="layui-input-inline">
					<input class="layui-input" type="text" name="ddl"  readonly="readonly">
				</div>
			</div>

		</form>
<!--		添加实验用的表单-->
		<div class="addcourse-form" style="display: none">
			<div class="title">
				<h1>添加新的实验</h1>
			</div>
			<form class="layui-form " lay-filter="addcourse-form" action="" >
				<div class="left-content">


					<div class="layui-form-item long-input">
						<label class="layui-form-label">实验名称</label>
						<div class="layui-input-inline">
							<input class="layui-input" type="text" name="experimentName" placeholder="请填入实验名称" required
								   lay-verify="required">
						</div>
					</div>

					<div class="layui-form-item long-input">
						<label class="layui-form-label">实验地点</label>
						<div class="layui-input-inline">
							<input class="layui-input" type="text" name="experimentAddress" placeholder="机房之间用;分隔。例:'1001;1003;1006;'" required
								   lay-verify="required|computerRoom">
						</div>
					</div>

					<div class="layui-form-item">
						<div class="layui-inline short-input">
							<label class="layui-form-label">年份</label>
							<div class="layui-input-inline">
								<input name="experimentYear" id="experimentYear" type="text" class="layui-input" placeholder="请选择年份" required
									   lay-verify="required"
								>
							</div>
						</div>

						<div class="layui-inline short-input">
							<label class="layui-form-label term-label">学期</label>
							<div class="layui-input-inline">
								<select name="experimentTerm" lay-verify="required" lay-search>
									<option value="">请选择学期</option>
									<option value="1">第一学期</option>
									<option value="2">第二学期</option>
								</select>
								<!--                        <input class="layui-input" type="text" name="experimentTerm" placeholder="" required-->
								<!--                               lay-verify="required">-->
							</div>
						</div>
					</div>

					<div class="layui-form-item long-input">
						<label class="layui-form-label">报告截止日期</label>
						<div class="layui-input-inline">
							<input class="layui-input" type="text" id="experimentDdl" name="experimentDdl" placeholder="请选择截止日期" required
								   lay-verify="required">
						</div>
					</div>
				</div>

				<div class="right-content">
					<div class="layui-form-item introduction">
						<label class="layui-form-label">实验简介</label>
						<div class="layui-input-block">
                <textarea class="layui-textarea" type="text" name="experimentIntroduction"  required
						  lay-verify="required" placeholder="请编写实验简介"></textarea>
						</div>
					</div>
					<div class="layui-form-item file-upload-content">
						<label class="layui-form-label">实验模板上传</label>
						<div class="layui-input-block">
							<div class="file-upload">
								<input  type="file" name="uploadFile"  id="file" required
										lay-verify="required" value="模板上传">
							</div>
						</div>
					</div>
				</div>

				<div class="layui-form-item">
					<div class="layui-input-block">
						<button class="layui-btn submitbtn" lay-submit lay-filter="save-edit">添加实验</button>
						<button type="reset" class="layui-btn layui-btn-primary resetbtn">重置表单</button>
					</div>
				</div>

			</form>
		</div>

		<script src="layui/layui.js"></script>
		<script src="js/jquery.min.js"></script>

		<!-- 实验老师的工具按钮 -->
		<script type="text/html" id="toolbar_experiment_list">
				<button class="layui-btn " lay-event="add">创建新实验</button>
		</script>
		<script type="text/html" id="rowOperation">
			<div class="layui-btn-container" >
			        <a class="layui-btn layui-icon  layui-btn-normal  layui-btn-sm" lay-event="info">&#xe615; 详情</a>
			        <a class="layui-btn layui-icon   layui-btn-sm" lay-event="manage">&#xe642; 管理</a>
			        <!-- <a class="layui-btn layui-icon  layui-btn-danger   layui-btn-xs" lay-event="del">&#xe640;删除</a> -->
			</div>
		</script>

<!--		添加实验表格的js-->
		<script>
			layui.use(['form', 'laydate', 'jquery', 'table'], function () {
				var form = layui.form;
				var laydate = layui.laydate;
				var $ = layui.jquery;
				var table = layui.table;
				laydate.render({
					elem: '.addcourse-form #experimentYear',
					type: 'year',
					trigger: 'click'
				});

				laydate.render({
					elem: '.addcourse-form #experimentDdl',
					trigger: 'click'
				});

				form.verify({
					computerRoom: [/^(10(0[0-9]|1[0-3]);)+$/, '目前机房只开放1001-1013,请检查机房格式。不同机房之间用英文分号隔离,例："1001;1003;1013;"']
				});


				form.on('submit(save-edit)', function (data) {
					alert(JSON.stringify(data.field));
					var formData = new FormData();
					formData.append("file", document.getElementById("file").files[0]);
					for (var i in data.field) {
						if (i != "file") {
							formData.append(i, data.field[i]);
						}
					}
					$.ajax({
						//todo：添加新的实验接口.
						url: "UploadExperimentServlet",
						type: "POST",
						data: formData,
						contentType: false,
						processData: false,
						success: function (returnData) {
							if (returnData == "success") {
								table.reload('experiment_list');
								layer.closeAll();
								layer.msg("添加实验成功", {icon: 6, anim: 6});
							} else if (returnData == "false") {
								layer.msg("添加实验失败", {icon: 5, anim: 6})
							}
						},
						error: function () {
							layer.msg("添加实验请求失败", {icon: 5, anim: 6})
						}
					});
					return false;
				})
			})
		</script>

<!--		原本的js-->
		<script>
			layui.use(['element', 'form', 'table','laydate'], function() {
				var $ = layui.jquery;
				var element = layui.element;
				var form = layui.form;
				var table = layui.table;
				var laydate = layui.laydate;


				//年选择器
				laydate.render({
				    elem: '#search_year'
				    ,type: 'year'
				});

				//表格渲染
				var tableIns = table.render({
					elem: '#experiment_list',
					height: 'full',
					url: 'ATeacherExperimentsServlet', //todo:某个实验老师的表格数据接口
					toolbar: '#toolbar_experiment_list', //开启头部工具栏，并为其绑定左侧模板
					defaultToolbar: ['filter', 'exports', 'print'],
					title: '实验列表',
					initSort: {field:'id', type:'desc'},
					loading:true,
					page: true,
					cols: [
					    [{field:'id', title:'实验ID',minWidth:80,fixed:'left',unresize:true,sort:true,style:"color:red"}
					    ,{field:'exName', title:'实验名称', minWidth:160,sort:true}
					    ,{field:'room', title:'上机教室', minWidth:160,sort:true,templet: function(d){return '计算机院办'+"<b>"+d.room+"</b>";}}
					    ,{field:'year', title:'年份', minWidth:80,sort:true,templet: function(d){return "<b>"+d.year+"</b>" +'年';}}
					    ,{field:'term', title:'学期',minWidth:80,sort:true,templet: function(d){return  '第'+"<b>"+d.term+"</b>"+'学期';}}
						,{field:'ddl',title:'报告截止日期',minWidth:80,sort:true}
						// ,{field:'studentNum',title:'选课人数',minWidth:50,sort:true}
						,{field:'operation',fixed: 'right', title:'操作',toolbar: '#rowOperation', minWidth:190}
					    ]
					]
				});

				// 搜索
				var $ = layui.$, active = {
				    reload: function(){
						// 获取搜索数据
				      var reload_exName = $('#search_exName').val();
				      var reload_year = $('#search_year').val();
				      var reload_term = $('#search_term').val();
				        if(reload_term!=0){
							// 执行重载
							if(reload_exName!=''&&reload_year!=''){
								tableIns.reload({
									page: {
										curr: 1 //重新从第 1 页开始
									}
									,where: {
										key: {
											exName: reload_exName,
											year:reload_year,
											term:reload_term
										}
									},
									//todo: 如果搜索失败试试在这里加 url:
								});
							}
						}
						else{
							//执行重载
							tableIns.reload({
								page: {
									curr: 1 //重新从第 1 页开始
								}
								,where: {
									key: {
										exName: reload_exName,
										year:reload_year
									}
								},
								//todo: 如果搜索失败试试在这里加 url:
							});
						}
					}
				  };

				$('.layui-card-header .ex_search').on('click', function(){
				    var type = $(this).data('type');
				    active[type] ? active[type].call(this) : '';
				  });

				//头工具栏事件(添加新实验)
				table.on('toolbar(experiment_list)', function(obj) {
					if(obj.event==="add"){
						var layerIndex = layer.open({
							type: 1,
							title: "创建新实验",
							content: $(".addcourse-form"),
							skin: "layui-layer-molv",
							area: ['1180px', '500px'],
							shadeClose: true,
							end:function () {
								$('.addcourse-form form')[0].reset();
							}
						})
					}
				});


				table.on('tool(experiment_list)',function(obj){
					var data = obj.data;
					if(obj.event==='info'){
					    var layerIndex = layer.open({
					        type: 1,
					        title: "查看详情",
					        content: $(".info-form"),
					        skin: "layui-layer-molv",
					        area: ['500px', '450px'],
					        shadeClose: true,
					     })
						form.val('info-form',data);
					}else if(obj.event==="manage"){
						$.ajax({
							//todo：后端session切换当前实验.给定实验id，返回实验详情，顺便增加一个returndata.flag,用来看是否成功
							url: "SwitchExperimentServlet",
							type: "post",
							data: "id="+data.id,
							dataType: 'text',
							success: function (returnDataStr) {	//返回实验的简介
								returnDataStr = returnDataStr.replace('\\','\\\\');
								var returnData =  JSON.parse(returnDataStr);
								if(returnData.flag==="success"){
									var experimentId = data.id;
									//开始切换实验,核心中的核心！！！老天保佑！！！
									//1.给自己的js变量赋值
									window.parent.currentExperimentId = experimentId;
									//2.切换iframe框架
									window.parent.document.getElementById("experimentPageFrame").contentWindow.scrollTo(0,0);
									window.parent.document.getElementById("experimentListFrame").style.zIndex = '0';
									window.parent.document.getElementById("experimentPageFrame").style.zIndex = '100';
									//3.给form赋值,testJson换成returnData
									// var testJson = {id:123
									// 	,experimentName:"nihao",
									// 	experimentAddress:1002,
									// 	experimentYear:"2020",
									// 	experimentTerm:1,
									// 	experimentDdl:"2020-10-10",
									// 	experimentIntroduction:"hello shijie!!!"};
									//因为lay-filter只能找到本页的东西，所以把函数写到了那一页，并且用了json。耍花招，值传递。
									window.parent.document.getElementById("experimentPageFrame").contentWindow.initExperimentInfoForm(JSON.stringify(returnData));//todo:改为returnData
									//4.重新加载表格
									window.parent.document.getElementById("experimentPageFrame").contentWindow.reloadTable();

								}else{
									layer.msg("管理实验失败", {icon: 5, anim: 6})
								}
							},
							error: function () {
								layer.msg("管理实验请求失败", {icon: 5, anim: 6});
								// 以下可以测试
								
								// var experimentId = data.id;
								// //开始切换实验,核心中的核心！！！老天保佑！！！
								// //1.给自己的js变量赋值
								// window.parent.currentExperimentId = experimentId;
								// //2.切换iframe框架
								// window.parent.document.getElementById("experimentListFrame").style.zIndex = '0';
								// window.parent.document.getElementById("experimentPageFrame").style.zIndex = '100';
								// window.parent.document.getElementById("experimentPageFrame").contentWindow.scrollTo(0,0);
								// //3.给form赋值,testJson换成returnData
								// var testJson = {id:123
								// 	,experimentName:"nihoa",
								// 	experimentAddress:1002,
								// 	experimentYear:"2020",
								// 	experimentTerm:1,
								// 	experimentDdl:"2020-10-10",
								// 	experimentIntroduction:"hello shijie!!!"};
								// //因为lay-filter只能找到本页的东西，所以把函数写到了那一页，并且用了json。耍花招，值传递。
								// window.parent.document.getElementById("experimentPageFrame").contentWindow.initExperimentInfoForm(JSON.stringify(testJson));
								// //4.重新加载表格
								// window.parent.document.getElementById("experimentPageFrame").contentWindow.reloadTable();
							}
						});



					}
				});


			});
		</script>


	</body>
</html>
